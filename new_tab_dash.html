<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>newtab</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="theme-dusk">
    <h3>new tab dash</h3>
    <div class="pr-box">
        <div class="section-header">GitHub</div>
        <div class="pr-label">
            <span id="assignedCount">-</span> <a href="https://github.com/pulls/assigned" target="_blank" class="setup-link">Assigned</a> â€¢ 
            <span id="mentionedCount">-</span> <a href="https://github.com/pulls/mentioned" target="_blank" class="setup-link">Mentioned</a>
        </div>
        <div class="pr-label">
            <span id="prCount">-</span> 
            <a href="https://github.com/pulls/review-requested" target="_blank" class="setup-link">Reviews</a>
        </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="pr-list" id="prList"></div>
        
        <div class="pr-label">
            <span id="myPrCount">-</span> 
            <a href="https://github.com/pulls" target="_blank" class="setup-link">My PRs</a>
        </div>
        <div class="pr-list" id="myPrList"></div>

        <div class="pr-label">
            <div class="section-header">Jira</div>
            <span id="jiraCount">-</span> <a href="https://jira.atlassian.net/jira/your-work" id="jiraTicketsLink" target="_blank" class="setup-link">Tickets</a>
            <a href="#" class="hide-section" id="hideJiraSection">Hide</a>
        </div>
        <div class="pr-list" id="jiraList"></div>

        <div class="setup-message" id="setupMessage">
            <p>You need to set up a GitHub token to view PR reviews.</p>
            <a href="https://github.com/settings/tokens/new?scopes=repo&description=PR%20Review%20Counter" 
               target="_blank" 
               class="setup-link">
                Create GitHub Token
            </a>
            <div id="tokenInputContainer">
                <input type="text" 
                       class="token-input" 
                       id="tokenInput" 
                       placeholder="Paste your GitHub token here">
                <button class="save-button" id="saveToken">Save Token</button>
            </div>
        </div>

        <div class="setup-message" id="jiraSetupMessage">
            <p>Configure Jira Integration</p>
            <a href="https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/" 
               target="_blank" 
               class="setup-link">
                How to get your Jira API token
            </a>
            <div id="jiraInputContainer">
                <input type="text" 
                       class="token-input" 
                       id="jiraDomainInput" 
                       placeholder="Your Jira domain (e.g., company.atlassian.net)">
                <input type="text" 
                       class="token-input" 
                       id="jiraEmailInput" 
                       placeholder="Your Jira email">
                <input type="text" 
                       class="token-input" 
                       id="jiraTokenInput" 
                       placeholder="Your Jira API token">
                <button class="save-button" id="saveJiraConfig">Save Jira Config</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-bar-left">
                <div class="status-icons">
                    <div class="status-icon" id="githubStatus">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        <div class="credential-modal" id="githubCredentialModal">
                            <div class="credential-info">
                                <span class="credential-label">Username:</span>
                                <span class="credential-value" id="githubUsernameDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Token:</span>
                                <span class="credential-value" id="githubTokenDisplay">-</span>
                            </div>
                            <a class="remove-credentials" id="removeGithubCredentials">Remove credentials</a>
                        </div>
                    </div>
                    <div class="status-icon" id="jiraStatus">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.808 7.552L8.69.667 8 0 2.642 5.183l-2.45 2.37A.623.623 0 000 8c0 .168.069.329.192.447l4.895 4.73L8 16l5.358-5.183 2.45-2.37a.623.623 0 00.192-.447.623.623 0 00-.192-.448zM8 10.365L5.554 8 8 5.635 10.446 8 8 10.365z"/>
                            <path d="M8 5.635c-1.26-1.22-1.26-3.197 0-4.417L3.554 5.183 5.554 8 8 5.635z" fill-opacity="0.3"/>
                            <path d="M10.446 8l-2.446 2.365c1.26 1.22 1.26 3.197 0 4.417l4.446-3.965L10.446 8z" fill-opacity="0.3"/>
                        </svg>
                        <div class="credential-modal" id="jiraCredentialModal">
                            <div class="credential-info">
                                <span class="credential-label">Domain:</span>
                                <span class="credential-value" id="jiraDomainDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Email:</span>
                                <span class="credential-value" id="jiraEmailDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Token:</span>
                                <span class="credential-value" id="jiraTokenDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Visibility:</span>
                                <a href="#" class="hide-section" id="toggleJiraVisibility">Show/Hide Section</a>
                            </div>
                            <a class="remove-credentials" id="removeJiraCredentials">Remove credentials</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-bar-right">
                <div class="user-info" id="userInfo"></div>
                <div class="cache-info" id="cacheInfo"></div>
            </div>
        </div>
    </div>

    <div class="theme-selector">
        <div class="theme-icon theme-dusk active" title="Dusk Theme"></div>
        <div class="theme-icon theme-sunrise" title="Sunrise Theme"></div>
        <div class="theme-icon theme-sunset" title="Sunset Theme"></div>
        <div class="theme-icon theme-aurora" title="Aurora Theme"></div>
        <div class="theme-icon theme-twilight" title="Twilight Theme"></div>
        <div class="theme-icon theme-ocean" title="Ocean Theme"></div>
    </div>

    <script>
        const GITHUB_CONFIG = {
            token: localStorage.getItem('githubToken') || '',
            username: localStorage.getItem('githubUsername') || '',
            cacheDuration: 5 * 60 * 1000, // 5 minutes in milliseconds
            cachePrefix: 'github_cache_',
            cacheTimer: null
        };

        const JIRA_CONFIG = {
            domain: localStorage.getItem('jiraDomain') || '',
            token: localStorage.getItem('jiraToken') || '',
            email: localStorage.getItem('jiraEmail') || '',
            cacheDuration: 5 * 60 * 1000, // 5 minutes in milliseconds
            cachePrefix: 'jira_cache_',
            cacheTimer: null,
            isVisible: localStorage.getItem('jiraVisible') !== 'false' // Default to true if not set
        };

        // Cache management functions
        function getCacheKey(endpoint) {
            return `${GITHUB_CONFIG.cachePrefix}${endpoint}`;
        }

        function updateCacheTimer() {
            const cacheInfo = document.getElementById('cacheInfo');
            const allCacheKeys = Object.keys(localStorage).filter(key => key.startsWith(GITHUB_CONFIG.cachePrefix));
            
            if (allCacheKeys.length === 0) {
                cacheInfo.textContent = '';
                if (GITHUB_CONFIG.cacheTimer) {
                    clearInterval(GITHUB_CONFIG.cacheTimer);
                    GITHUB_CONFIG.cacheTimer = null;
                }
                return;
            }

            let maxTimeLeft = 0;
            let hasValidCache = false;
            
            allCacheKeys.forEach(key => {
                try {
                    const { timestamp } = JSON.parse(localStorage.getItem(key));
                    const timeLeft = GITHUB_CONFIG.cacheDuration - (Date.now() - timestamp);
                    if (timeLeft > 0) {
                        hasValidCache = true;
                        maxTimeLeft = Math.max(maxTimeLeft, timeLeft);
                    }
                } catch (e) {
                    console.error('Cache parse error:', e);
                }
            });

            if (!hasValidCache || maxTimeLeft <= 0) {
                cacheInfo.textContent = '';
                if (GITHUB_CONFIG.cacheTimer) {
                    clearInterval(GITHUB_CONFIG.cacheTimer);
                    GITHUB_CONFIG.cacheTimer = null;
                }
                return;
            }

            const minutes = Math.floor(maxTimeLeft / 60000);
            const seconds = Math.floor((maxTimeLeft % 60000) / 1000);
            cacheInfo.textContent = `ttl ${minutes}m ${seconds}s`;
        }

        // Initialize cache timer if there's cached data
        function initializeCacheTimer() {
            const allCacheKeys = Object.keys(localStorage).filter(key => key.startsWith(GITHUB_CONFIG.cachePrefix));
            if (allCacheKeys.length > 0) {
                updateCacheTimer();
                if (!GITHUB_CONFIG.cacheTimer) {
                    GITHUB_CONFIG.cacheTimer = setInterval(updateCacheTimer, 1000);
                }
            }
        }

        // Call initializeCacheTimer when the page loads
        initializeCacheTimer();

        function getCachedData(endpoint) {
            const cacheKey = getCacheKey(endpoint);
            const cached = localStorage.getItem(cacheKey);
            if (!cached) return null;

            try {
                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();
                const timeLeft = GITHUB_CONFIG.cacheDuration - (now - timestamp);
                
                if (timeLeft > 0) {
                    // Start or restart the timer if not running
                    if (!GITHUB_CONFIG.cacheTimer) {
                        GITHUB_CONFIG.cacheTimer = setInterval(updateCacheTimer, 1000);
                    }
                    updateCacheTimer();
                    return data;
                }
                // Cache expired, remove it
                localStorage.removeItem(cacheKey);
                updateCacheTimer();
                return null;
            } catch (e) {
                console.error('Cache parse error:', e);
                updateCacheTimer();
                return null;
            }
        }

        function setCachedData(endpoint, data) {
            const cacheKey = getCacheKey(endpoint);
            const cacheData = {
                data,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                // Start or restart the timer
                if (!GITHUB_CONFIG.cacheTimer) {
                    GITHUB_CONFIG.cacheTimer = setInterval(updateCacheTimer, 1000);
                }
                updateCacheTimer();
            } catch (e) {
                console.error('Cache storage error:', e);
                updateCacheTimer();
            }
        }

        async function fetchWithCache(url, options = {}) {
            const cachedData = getCachedData(url);
            if (cachedData) {
                // console.log('Using cached data for:', url);
                return {
                    ok: true,
                    status: 200,
                    json: async () => cachedData
                };
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                setCachedData(url, data);
                return {
                    ok: true,
                    status: 200,
                    json: async () => data
                };
            } catch (error) {
                console.error('Fetch error:', error);
                updateCacheTimer();
                throw error;
            }
        }

        function updateTokenDisplay() {
            const setupMessage = document.getElementById('setupMessage');
            const githubStatus = document.getElementById('githubStatus');

            if (GITHUB_CONFIG.token) {
                // Update status indicator
                githubStatus.className = 'status-icon connected';
                // Hide setup message
                setupMessage.style.display = 'none';
            } else {
                // Update status indicator
                githubStatus.className = 'status-icon disconnected';
                // Show setup message
                setupMessage.style.display = 'block';
            }
        }

        // Debug logging
        // console.log('Initial token:', GITHUB_CONFIG.token ? 'Present' : 'Missing');
        updateTokenDisplay();

        async function testToken() {
            try {
                // console.log('Testing token...');
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                // console.log('Token test response status:', response.status);
                
                if (response.ok) {
                    const userData = await response.json();
                    // console.log('Token valid, connected as:', userData.login);
                    GITHUB_CONFIG.username = userData.login;
                    localStorage.setItem('githubUsername', userData.login);
                    return true;
                } else {
                    const errorData = await response.json();
                    // console.error('Token validation failed:', response.status, errorData);
                    return false;
                }
            } catch (error) {
                // console.error('Error testing token:', error);
                return false;
            }
        }

        async function fetchPRReviews() {
            try {
                // console.log('Fetching PR reviews...');
                if (!GITHUB_CONFIG.token) {
                    // console.log('No token found');
                    document.getElementById('setupMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'GitHub token not configured';
                    return;
                }

                // Test the token first
                const isValid = await testToken();
                if (!isValid) {
                    // console.log('Token invalid');
                    document.getElementById('setupMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'GitHub token is invalid or expired';
                    localStorage.removeItem('githubToken'); // Clear invalid token
                    GITHUB_CONFIG.token = '';
                    updateTokenDisplay(); // Update UI after clearing token
                    return;
                }

                const response = await fetchWithCache('https://api.github.com/search/issues?q=is:pr+is:open+review-requested:@me', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                // console.log('PR fetch response:', response);

                if (response.status === 401) {
                    // console.log('Token unauthorized');
                    document.getElementById('setupMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'GitHub token is invalid or expired';
                    localStorage.removeItem('githubToken'); // Clear invalid token
                    GITHUB_CONFIG.token = '';
                    updateTokenDisplay(); // Update UI after clearing token
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to fetch PR reviews: ${errorData.message || response.status}`);
                }

                const data = await response.json();
                // console.log('PR data:', data);
                const prCount = data.total_count;
                document.getElementById('prCount').textContent = prCount;
                
                // Update PR list
                const prList = document.getElementById('prList');
                prList.innerHTML = '';
                
                if (data.items.length === 0) {
                    const noReviewsMessage = document.createElement('div');
                    noReviewsMessage.className = 'pr-item';
                    noReviewsMessage.innerHTML = 'nothing to review right now. amazing.';
                    prList.appendChild(noReviewsMessage);
                } else {
                    data.items.forEach(pr => {
                        const repo = pr.repository_url.split('/').slice(-2).join('/');
                        const prItem = document.createElement('div');
                        prItem.className = 'pr-item';
                        
                        // Calculate PR age
                        const updatedTime = new Date(pr.updated_at);
                        const now = new Date();
                        const diffDays = Math.floor((now - updatedTime) / (1000 * 60 * 60 * 24));
                        
                        let ageClass = 'pr-age-old';
                        if (diffDays === 0) {
                            ageClass = 'pr-age-new';
                        } else if (diffDays <= 2) {
                            ageClass = 'pr-age-recent';
                        }
                        
                        const ageText = diffDays === 0 ? '<1d' : `${diffDays}d`;
                        
                        prItem.innerHTML = `
                            <div class="pr-title">
                                <span class="pr-repo">${repo}</span>
                                <span class="pr-number">#${pr.number}</span>
                                <span class="pr-age ${ageClass}">${ageText}</span>
                            </div>
                            <a href="${pr.html_url}" target="_blank" class="pr-link">${pr.title}</a>
                        `;
                        prList.appendChild(prItem);
                    });
                }

                // Fetch assigned PRs
                const assignedResponse = await fetchWithCache('https://api.github.com/search/issues?q=is:pr+is:open+assignee:@me', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (assignedResponse.ok) {
                    const assignedData = await assignedResponse.json();
                    document.getElementById('assignedCount').textContent = assignedData.total_count;
                }

                // Fetch mentioned PRs
                const mentionedResponse = await fetchWithCache('https://api.github.com/search/issues?q=is:pr+is:open+mentions:@me', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (mentionedResponse.ok) {
                    const mentionedData = await mentionedResponse.json();
                    document.getElementById('mentionedCount').textContent = mentionedData.total_count;
                }

                // Fetch user's open PRs
                const myPrResponse = await fetchWithCache('https://api.github.com/search/issues?q=is:pr+is:open+author:@me', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (myPrResponse.ok) {
                    const myPrData = await myPrResponse.json();
                    const myPrCount = myPrData.total_count;
                    document.getElementById('myPrCount').textContent = myPrCount;
                    
                    // Update user's PR list
                    const myPrList = document.getElementById('myPrList');
                    const myPrLabel = document.querySelector('.pr-label:has(#myPrCount)');
                    
                    if (myPrData.items.length === 0) {
                        myPrList.style.display = 'none';
                        myPrLabel.style.display = 'none';
                    } else {
                        myPrList.style.display = 'block';
                        myPrLabel.style.display = 'block';
                        myPrList.innerHTML = '';
                        myPrData.items.forEach(pr => {
                            const repo = pr.repository_url.split('/').slice(-2).join('/');
                            const prItem = document.createElement('div');
                            prItem.className = 'pr-item';
                            prItem.innerHTML = `
                                <div class="pr-title">
                                    <span class="pr-repo">${repo}</span>
                                    <span class="pr-number">#${pr.number}</span>
                                </div>
                                <a href="${pr.html_url}" target="_blank" class="pr-link">${pr.title}</a>
                            `;
                            myPrList.appendChild(prItem);
                        });
                    }
                }

                document.getElementById('setupMessage').style.display = 'none';
                document.getElementById('errorMessage').textContent = '';
            } catch (error) {
                console.error('Error in fetchPRReviews:', error);
                document.getElementById('errorMessage').textContent = `Error: ${error.message}`;
            }
        }

        // Setup token saving
        document.getElementById('saveToken').addEventListener('click', async () => {
            const token = document.getElementById('tokenInput').value.trim();
            // console.log('Saving new token...');
            if (token) {
                localStorage.setItem('githubToken', token);
                GITHUB_CONFIG.token = token;
                updateTokenDisplay();
                await fetchPRReviews();
            }
        });

        // If we have a token, try to use it
        if (GITHUB_CONFIG.token) {
            // console.log('Found existing token, attempting to use it...');
            fetchPRReviews();
        } else {
            // console.log('No existing token found');
            document.getElementById('setupMessage').style.display = 'block';
        }

        // Setup Jira config saving
        document.getElementById('saveJiraConfig').addEventListener('click', async () => {
            const domain = document.getElementById('jiraDomainInput').value.trim();
            const email = document.getElementById('jiraEmailInput').value.trim();
            const token = document.getElementById('jiraTokenInput').value.trim();
            if (domain && email && token) {
                localStorage.setItem('jiraDomain', domain);
                localStorage.setItem('jiraEmail', email);
                localStorage.setItem('jiraToken', token);
                JIRA_CONFIG.domain = domain;
                JIRA_CONFIG.email = email;
                JIRA_CONFIG.token = token;
                updateJiraDisplay();
                await fetchJiraTickets();
            }
        });

        // If we have Jira config, try to use it
        if (JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token) {
            // console.log('Found existing Jira config, attempting to use it...');
            document.getElementById('jiraSetupMessage').style.display = 'none';
            fetchJiraTickets();
        } else {
            // console.log('No existing Jira config found');
            document.getElementById('jiraSetupMessage').style.display = 'block';
        }

        // Initialize Jira visibility state
        function initializeJiraVisibility() {
            const jiraList = document.getElementById('jiraList');
            const jiraCount = document.getElementById('jiraCount').parentElement;
            const hideJiraSection = document.getElementById('hideJiraSection');
            const toggleJiraVisibility = document.getElementById('toggleJiraVisibility');
            const jiraSetupMessage = document.getElementById('jiraSetupMessage');
            const jiraTicketsLink = document.getElementById('jiraTicketsLink');

            // Update Jira tickets link
            if (JIRA_CONFIG.domain) {
                let domain = JIRA_CONFIG.domain;
                if (!domain.includes('.atlassian.net')) {
                    domain = `${domain}.atlassian.net`;
                }
                jiraTicketsLink.href = `https://${domain}/jira/your-work`;
            }

            // console.log('Current Jira Configuration:', {
            //     domain: JIRA_CONFIG.domain,
            //     email: JIRA_CONFIG.email,
            //     token: JIRA_CONFIG.token ? 'Present' : 'Missing',
            //     isVisible: JIRA_CONFIG.isVisible
            // });

            const hasCredentials = JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token;

            if (hasCredentials) {
                // Update status indicator
                jiraStatus.className = 'status-icon connected';
                // Hide setup message
                jiraSetupMessage.style.display = 'none';
                // Hide the hide link in the main area
                hideJiraSection.style.display = 'none';
                // Show tickets
                jiraList.style.display = 'block';
                jiraCount.style.display = 'block';
                toggleJiraVisibility.textContent = 'Hide Section';
                // Clear input fields
                const inputs = document.querySelectorAll('#jiraDomainInput, #jiraEmailInput, #jiraTokenInput');
                inputs.forEach(input => input.value = '');
            } else {
                // Update status indicator
                jiraStatus.className = 'status-icon disconnected';
                // Show/hide setup message based on visibility
                jiraSetupMessage.style.display = JIRA_CONFIG.isVisible ? 'block' : 'none';
                // Show/hide the hide link based on visibility
                hideJiraSection.style.display = JIRA_CONFIG.isVisible ? 'inline' : 'none';
                // Hide tickets
                jiraList.style.display = 'none';
                jiraCount.style.display = 'none';
                toggleJiraVisibility.textContent = JIRA_CONFIG.isVisible ? 'Hide Section' : 'Show Section';
            }
        }

        // Call initializeJiraVisibility when the page loads
        initializeJiraVisibility();

        function updateJiraDisplay() {
            const jiraDomainInput = document.getElementById('jiraDomainInput');
            const jiraEmailInput = document.getElementById('jiraEmailInput');
            const jiraTokenInput = document.getElementById('jiraTokenInput');
            const jiraSetupMessage = document.getElementById('jiraSetupMessage');
            const jiraStatus = document.getElementById('jiraStatus');
            const hideJiraSection = document.getElementById('hideJiraSection');
            const jiraList = document.getElementById('jiraList');
            const jiraCount = document.getElementById('jiraCount').parentElement;
            const toggleJiraVisibility = document.getElementById('toggleJiraVisibility');
            const jiraTicketsLink = document.getElementById('jiraTicketsLink');

            // Update Jira tickets link
            if (JIRA_CONFIG.domain) {
                let domain = JIRA_CONFIG.domain;
                if (!domain.includes('.atlassian.net')) {
                    domain = `${domain}.atlassian.net`;
                }
                jiraTicketsLink.href = `https://${domain}/jira/your-work`;
            }

            // console.log('Current Jira Configuration:', {
            //     domain: JIRA_CONFIG.domain,
            //     email: JIRA_CONFIG.email,
            //     token: JIRA_CONFIG.token ? 'Present' : 'Missing',
            //     isVisible: JIRA_CONFIG.isVisible
            // });

            const hasCredentials = JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token;

            if (hasCredentials) {
                // Update status indicator
                jiraStatus.className = 'status-icon connected';
                // Hide setup message
                jiraSetupMessage.style.display = 'none';
                // Hide the hide link in the main area
                hideJiraSection.style.display = 'none';
                // Show tickets
                jiraList.style.display = 'block';
                jiraCount.style.display = 'block';
                toggleJiraVisibility.textContent = 'Hide Section';
                // Clear input fields
                const inputs = document.querySelectorAll('#jiraDomainInput, #jiraEmailInput, #jiraTokenInput');
                inputs.forEach(input => input.value = '');
            } else {
                // Update status indicator
                jiraStatus.className = 'status-icon disconnected';
                // Show/hide setup message based on visibility
                jiraSetupMessage.style.display = JIRA_CONFIG.isVisible ? 'block' : 'none';
                // Show/hide the hide link based on visibility
                hideJiraSection.style.display = JIRA_CONFIG.isVisible ? 'inline' : 'none';
                // Hide tickets
                jiraList.style.display = 'none';
                jiraCount.style.display = 'none';
                toggleJiraVisibility.textContent = JIRA_CONFIG.isVisible ? 'Hide Section' : 'Show Section';
            }
        }

        async function fetchJiraTickets() {
            try {
                // console.log('Fetching Jira tickets...');
                // console.log('Jira Config:', {
                //     domain: JIRA_CONFIG.domain,
                //     email: JIRA_CONFIG.email,
                //     hasToken: !!JIRA_CONFIG.token
                // });

                if (!JIRA_CONFIG.domain || !JIRA_CONFIG.email || !JIRA_CONFIG.token) {
                    // console.log('Jira config incomplete');
                    document.getElementById('jiraSetupMessage').style.display = 'block';
                    document.getElementById('jiraStatus').className = 'status-icon disconnected';
                    return;
                }

                // Ensure domain is in correct format
                let domain = JIRA_CONFIG.domain;
                if (!domain.includes('.atlassian.net')) {
                    domain = `${domain}.atlassian.net`;
                }

                // First, test authentication with a simple API call
                const testUrl = `https://${domain}/rest/api/2/myself`;
                // console.log('Testing Jira authentication...');
                
                const testResponse = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Basic ${btoa(`${JIRA_CONFIG.email}:${JIRA_CONFIG.token}`)}`,
                        'Accept': 'application/json'
                    }
                });

                if (!testResponse.ok) {
                    const errorText = await testResponse.text();
                    console.error('Jira authentication failed:', testResponse.status, errorText);
                    document.getElementById('jiraStatus').className = 'status-icon disconnected';
                    throw new Error(`Jira authentication failed: ${testResponse.status}`);
                }

                const userData = await testResponse.json();
                // console.log('Jira authentication successful, logged in as:', userData.displayName);
                document.getElementById('jiraStatus').className = 'status-icon connected';

                // Now fetch the tickets
                const jql = 'assignee=currentUser() AND status not in (Done,Closed,Resolved) ORDER BY priority DESC, updated DESC';
                const url = `https://${domain}/rest/api/2/search?jql=${encodeURIComponent(jql)}&maxResults=100`;
                // console.log('Fetching Jira tickets from:', url);

                const response = await fetchWithCache(url, {
                    headers: {
                        'Authorization': `Basic ${btoa(`${JIRA_CONFIG.email}:${JIRA_CONFIG.token}`)}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Jira API Error Response:', errorText);
                    throw new Error(`Failed to fetch Jira tickets: ${response.status}`);
                }

                const data = await response.json();
                // console.log('Jira API Response:', {
                //     total: data.total,
                //     numIssues: data.issues?.length || 0,
                //     maxResults: data.maxResults
                // });

                const ticketCount = data.total;
                document.getElementById('jiraCount').textContent = ticketCount;
                
                // Update Jira ticket list
                const jiraList = document.getElementById('jiraList');
                jiraList.innerHTML = '';
                
                if (data.issues && data.issues.length > 0) {
                    // Show first 6 tickets
                    const initialTickets = data.issues.slice(0, 6);
                    const remainingTickets = data.issues.slice(6);
                    
                    initialTickets.forEach(ticket => {
                        const ticketItem = document.createElement('div');
                        ticketItem.className = 'jira-ticket';
                        ticketItem.innerHTML = createTicketHTML(ticket, domain);
                        jiraList.appendChild(ticketItem);
                    });

                    // Add load more button if there are more tickets
                    if (remainingTickets.length > 0) {
                        const loadMoreButton = document.createElement('button');
                        loadMoreButton.className = 'load-more-button';
                        loadMoreButton.textContent = `Load ${Math.min(10, remainingTickets.length)} more tickets`;
                        
                        let displayedTickets = 6;
                        loadMoreButton.addEventListener('click', () => {
                            const nextBatch = data.issues.slice(displayedTickets, displayedTickets + 10);
                            nextBatch.forEach(ticket => {
                                const ticketItem = document.createElement('div');
                                ticketItem.className = 'jira-ticket';
                                ticketItem.innerHTML = createTicketHTML(ticket, domain);
                                jiraList.insertBefore(ticketItem, loadMoreButton);
                            });
                            
                            displayedTickets += nextBatch.length;
                            
                            if (displayedTickets >= data.issues.length) {
                                loadMoreButton.remove();
                            } else {
                                const remaining = data.issues.length - displayedTickets;
                                loadMoreButton.textContent = `Load ${Math.min(10, remaining)} more tickets`;
                            }
                        });
                        
                        jiraList.appendChild(loadMoreButton);
                    }
                } else {
                    jiraList.innerHTML = '<div class="pr-item">No tickets found</div>';
                }

                document.getElementById('jiraSetupMessage').style.display = 'none';
                document.getElementById('errorMessage').textContent = '';

            } catch (error) {
                console.error('Error in fetchJiraTickets:', error);
                document.getElementById('errorMessage').textContent = `Jira Error: ${error.message}`;
                document.getElementById('jiraStatus').className = 'status-icon disconnected';
                document.getElementById('jiraStatusText').textContent = 'Error';
                document.getElementById('jiraSetupMessage').style.display = 'block';
            }
        }

        // Helper function to create ticket HTML
        function createTicketHTML(ticket, domain) {
            let statusClass = 'status-todo';
            if (ticket.fields.status.name.toLowerCase().includes('progress')) {
                statusClass = 'status-in-progress';
            } else if (ticket.fields.status.name.toLowerCase().includes('done')) {
                statusClass = 'status-done';
            }

            // Calculate relative time and color
            const updatedTime = new Date(ticket.fields.updated);
            const now = new Date();
            const diffDays = Math.floor((now - updatedTime) / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((now - updatedTime) / (1000 * 60 * 60));
            
            let relativeTime;
            if (diffDays > 0) {
                relativeTime = `${diffDays}d`;
            } else if (diffHours > 0) {
                relativeTime = `${diffHours}h`;
            } else {
                relativeTime = '<1h';
            }

            // Color scale: green (new) -> yellow -> red (old)
            // 0-1 day: green
            // 1-3 days: yellow-green
            // 3-7 days: yellow
            // 7-14 days: orange
            // 14+ days: red
            let ageColor;
            if (diffDays === 0) {
                ageColor = '#2ecc71'; // muted green
            } else if (diffDays <= 1) {
                ageColor = '#5cb85c'; // muted yellow-green
            } else if (diffDays <= 3) {
                ageColor = '#ffff44'; // yellow
            } else if (diffDays <= 7) {
                ageColor = '#ff8844'; // orange
            } else {
                ageColor = '#ff4444'; // red
            }
            
            return `
                <div class="jira-ticket-content">
                    <div class="pr-title">
                        <span class="jira-key">${ticket.key}</span>
                        <span class="jira-status ${statusClass}">${ticket.fields.status.name}</span>
                        <span class="jira-priority" style="color: ${ticket.fields.priority.iconUrl.includes('highest') ? '#ff4444' : 
                                                                 ticket.fields.priority.iconUrl.includes('high') ? '#ff8844' : 
                                                                 ticket.fields.priority.iconUrl.includes('medium') ? '#ffcc44' : 
                                                                 '#2ecc71'}">${ticket.fields.priority.name}</span>
                    </div>
                    <a href="https://${domain}/browse/${ticket.key}" 
                       target="_blank" 
                       class="pr-link">${ticket.fields.summary}</a>
                </div>
                <span class="jira-ticket-age" style="color: ${ageColor}">${relativeTime}</span>
            `;
        }

        // Add click handler for cache info
        document.getElementById('cacheInfo').addEventListener('click', () => {
            // Clear all GitHub caches
            Object.keys(localStorage)
                .filter(key => key.startsWith(GITHUB_CONFIG.cachePrefix))
                .forEach(key => localStorage.removeItem(key));
            
            // Clear all Jira caches
            Object.keys(localStorage)
                .filter(key => key.startsWith(JIRA_CONFIG.cachePrefix))
                .forEach(key => localStorage.removeItem(key));
            
            // Update the display
            updateCacheTimer();
            
            // Refresh the data
            if (GITHUB_CONFIG.token) {
                fetchPRReviews();
            }
            if (JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token) {
                fetchJiraTickets();
            }
        });

        // Add credential display and removal functionality
        function updateCredentialDisplays() {
            // Update GitHub credential displays
            const githubToken = GITHUB_CONFIG.token;
            const githubTokenDisplay = document.getElementById('githubTokenDisplay');
            const githubUsernameDisplay = document.getElementById('githubUsernameDisplay');
            
            if (githubToken) {
                githubTokenDisplay.textContent = `â€¢â€¢â€¢â€¢${githubToken.slice(-4)}`;
                githubUsernameDisplay.textContent = GITHUB_CONFIG.username || '-';
            } else {
                githubTokenDisplay.textContent = '-';
                githubUsernameDisplay.textContent = '-';
            }

            // Update Jira credential displays
            const jiraDomainDisplay = document.getElementById('jiraDomainDisplay');
            const jiraEmailDisplay = document.getElementById('jiraEmailDisplay');
            const jiraTokenDisplay = document.getElementById('jiraTokenDisplay');
            const removeJiraCredentials = document.getElementById('removeJiraCredentials');
            const toggleJiraVisibility = document.getElementById('toggleJiraVisibility');
            const visibilityContainer = toggleJiraVisibility.parentElement;

            jiraDomainDisplay.textContent = JIRA_CONFIG.domain || '-';
            jiraEmailDisplay.textContent = JIRA_CONFIG.email || '-';
            if (JIRA_CONFIG.token) {
                jiraTokenDisplay.textContent = `â€¢â€¢â€¢â€¢${JIRA_CONFIG.token.slice(-4)}`;
            } else {
                jiraTokenDisplay.textContent = '-';
            }

            // Show/hide remove credentials link based on whether any credentials are set
            const hasAnyJiraCredentials = JIRA_CONFIG.domain || JIRA_CONFIG.email || JIRA_CONFIG.token;
            removeJiraCredentials.style.display = hasAnyJiraCredentials ? 'inline-block' : 'none';
            visibilityContainer.style.display = hasAnyJiraCredentials ? 'none' : 'block';
        }

        // Add click handlers for removing credentials
        document.getElementById('removeGithubCredentials').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('githubToken');
            localStorage.removeItem('githubUsername');
            GITHUB_CONFIG.token = '';
            GITHUB_CONFIG.username = '';
            updateTokenDisplay();
            updateCredentialDisplays();
            document.getElementById('setupMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = '';
        });

        document.getElementById('removeJiraCredentials').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('jiraDomain');
            localStorage.removeItem('jiraEmail');
            localStorage.removeItem('jiraToken');
            JIRA_CONFIG.domain = '';
            JIRA_CONFIG.email = '';
            JIRA_CONFIG.token = '';
            JIRA_CONFIG.isVisible = true; // Set to true so the next action is to hide
            localStorage.setItem('jiraVisible', true);
            document.getElementById('toggleJiraVisibility').textContent = 'Hide Section';
            updateJiraDisplay();
            updateCredentialDisplays();
            document.getElementById('jiraSetupMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = '';
        });

        // Update credential displays when the page loads
        updateCredentialDisplays();

        // Update credential displays when tokens are saved
        document.getElementById('saveToken').addEventListener('click', () => {
            setTimeout(updateCredentialDisplays, 100);
        });

        document.getElementById('saveJiraConfig').addEventListener('click', () => {
            setTimeout(updateCredentialDisplays, 100);
        });

        // Add click handler for toggling Jira visibility
        document.getElementById('toggleJiraVisibility').addEventListener('click', (e) => {
            e.preventDefault();
            JIRA_CONFIG.isVisible = !JIRA_CONFIG.isVisible;
            localStorage.setItem('jiraVisible', JIRA_CONFIG.isVisible);
            updateJiraDisplay();
            // If showing the section and no credentials are set, show the setup message
            if (JIRA_CONFIG.isVisible && !JIRA_CONFIG.domain && !JIRA_CONFIG.email && !JIRA_CONFIG.token) {
                document.getElementById('jiraSetupMessage').style.display = 'block';
            }
        });

        // Add click handler for hiding Jira section from main area
        document.getElementById('hideJiraSection').addEventListener('click', (e) => {
            e.preventDefault();
            JIRA_CONFIG.isVisible = false;
            localStorage.setItem('jiraVisible', false);
            updateJiraDisplay();
        });

        // Theme switching functionality
        document.querySelectorAll('.theme-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                // Remove active class from all icons
                document.querySelectorAll('.theme-icon').forEach(i => i.classList.remove('active'));
                // Add active class to clicked icon
                icon.classList.add('active');
                // Apply the theme
                const themeClass = icon.classList[1];
                document.body.className = themeClass;
                // Save the selected theme
                localStorage.setItem('selectedTheme', themeClass);
            });
        });

        // Load saved theme on page load
        const savedTheme = localStorage.getItem('selectedTheme');
        if (savedTheme) {
            document.body.className = savedTheme;
            // Update active theme icon
            document.querySelectorAll('.theme-icon').forEach(icon => {
                if (icon.classList.contains(savedTheme)) {
                    icon.classList.add('active');
                } else {
                    icon.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>