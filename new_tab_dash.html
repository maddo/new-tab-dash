<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>newtab</title>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pr-box {
            background-color: #2a1f35;
            border: 1px solid #6C5B7B;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            min-width: 600px;
            position: relative;
            padding-bottom: 40px; /* Make room for status bar */
        }

        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px 20px;
            background-color: #2a1f35;
            border-top: 1px solid #6C5B7B;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #F8B195;
            gap: 20px;
        }

        .status-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-bar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-icons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            position: relative;
            opacity: 1;
            transition: all 0.2s;
            cursor: pointer;
        }

        .status-icon.connected {
            color: #F8B195;
        }

        .status-icon.disconnected {
            color: #6C5B7B;
        }

        .status-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .credential-modal {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2a1f35;
            border: 1px solid #6C5B7B;
            border-radius: 8px;
            padding: 12px;
            min-width: 200px;
            z-index: 1000;
            display: none;
            font-size: 12px;
            color: #F8B195;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .status-icon:hover .credential-modal {
            display: block;
        }

        .credential-info {
            margin-bottom: 8px;
        }

        .credential-info:last-child {
            margin-bottom: 0;
        }

        .credential-label {
            color: #C06C84;
            margin-right: 4px;
        }

        .credential-value {
            font-family: monospace;
        }

        .remove-credentials {
            color: #C06C84;
            text-decoration: none;
            font-size: 12px;
            margin-top: 8px;
            display: inline-block;
            cursor: pointer;
        }

        .remove-credentials:hover {
            text-decoration: underline;
        }

        .settings-icon {
            cursor: pointer;
            color: #C06C84;
            font-size: 16px;
            transition: color 0.2s;
        }

        .settings-icon:hover {
            color: #F8B195;
        }

        .pr-count {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .pr-label {
            font-size: 14px;
            color: #C06C84;
            margin-top: 20px;
        }

        .pr-label:first-of-type {
            margin-top: 0;
        }

        .error-message {
            color: #F67280;
            font-size: 14px;
            margin-top: 10px;
        }

        .setup-message {
            color: #C06C84;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .setup-link {
            color: #F8B195;
            text-decoration: none;
        }

        .setup-link:hover {
            text-decoration: underline;
        }

        .token-input {
            background: #1a1a1a;
            border: 1px solid #6C5B7B;
            color: #F8B195;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            margin: 10px 0;
            font-family: monospace;
            display: block;
        }

        .save-button {
            background: #C06C84;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: block;
            margin-top: 10px;
        }

        .save-button:hover {
            background: #F67280;
        }

        .user-info {
            font-size: 12px;
            color: #C06C84;
            white-space: nowrap;
            min-width: 150px;
        }

        .token-info {
            font-size: 12px;
            color: #C06C84;
            font-family: monospace;
            white-space: nowrap;
            min-width: 150px;
        }

        .clear-token {
            color: #C06C84;
            text-decoration: none;
            font-size: 12px;
            margin-left: 10px;
            cursor: pointer;
        }

        .clear-token:hover {
            text-decoration: underline;
        }

        .pr-list {
            margin-top: 15px;
            text-align: left;
            font-size: 12px;
            color: #F8B195;
        }

        .pr-item {
            margin: 8px 0;
            padding-left: 10px;
            border-left: 2px solid #333;
        }

        .pr-title {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .pr-link {
            color: #F8B195;
            text-decoration: none;
            font-family: monospace;
        }

        .pr-link:hover {
            text-decoration: underline;
        }

        .jira-info {
            font-size: 12px;
            color: #C06C84;
            font-family: monospace;
            white-space: nowrap;
            min-width: 150px;
        }

        .jira-ticket {
            margin: 8px 0;
            padding-left: 10px;
            border-left: 2px solid #3b7fc4;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .jira-ticket-content {
            flex: 1;
        }

        .jira-ticket-age {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
            color: #C06C84;
            font-family: 'Inter', sans-serif;
        }

        .hide-section {
            font-size: 12px;
            color: #C06C84;
            text-decoration: none;
            margin-left: 10px;
            cursor: pointer;
        }

        .hide-section:hover {
            text-decoration: underline;
        }

        .jira-key {
            color: #F8B195;
            font-weight: 500;
        }

        .jira-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        .status-todo { background-color: #2a1f35; color: #F8B195; }
        .status-in-progress { background-color: #6C5B7B; color: #fff; }
        .status-done { background-color: #C06C84; color: #fff; }

        .clear-cache-button {
            background: #C06C84;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .clear-cache-button:hover {
            background: #F67280;
        }

        .load-more-button {
            background: #1a1a1a;
            color: #F8B195;
            border: 1px solid #6C5B7B;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .load-more-button:hover {
            background: #2a1f35;
            color: #F8B195;
            border-color: #C06C84;
        }

        .cache-info {
            font-size: 12px;
            color: #C06C84;
            font-family: monospace;
            min-width: 100px;
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
        }

        .cache-info:hover {
            color: #F8B195;
        }

        .cache-info::after {
            content: 'Refresh Results';
            position: absolute;
            bottom: 100%;
            right: 0;
            background: #2a1f35;
            color: #F8B195;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        .cache-info:hover::after {
            opacity: 1;
        }

        .theme-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            overflow: hidden;
            max-width: 24px;
        }

        .theme-selector:hover {
            max-width: 200px;
        }

        .theme-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        .theme-icon:hover {
            transform: scale(1.1);
        }

        .theme-icon.active {
            border-color: var(--text-primary);
        }

        .theme-icon:not(.active) {
            opacity: 0;
            transform: translateX(20px);
        }

        .theme-selector:hover .theme-icon:not(.active) {
            opacity: 1;
            transform: translateX(0);
        }

        /* Dusk Theme (Current) */
        .theme-dusk {
            --bg-primary: #000000;
            --bg-secondary: #2a1f35;
            --border-color: #6C5B7B;
            --text-primary: #F8B195;
            --text-secondary: #C06C84;
            --accent-color: #F67280;
            --status-todo: #2a1f35;
            --status-in-progress: #6C5B7B;
            --status-done: #C06C84;
        }

        /* Sunrise Theme */
        .theme-sunrise {
            --bg-primary: #000000;
            --bg-secondary: #2c1a3d;
            --border-color: #8B5FBF;
            --text-primary: #FFB6C1;
            --text-secondary: #FF69B4;
            --accent-color: #FF1493;
            --status-todo: #2c1a3d;
            --status-in-progress: #8B5FBF;
            --status-done: #FF69B4;
        }

        /* Sunset Theme */
        .theme-sunset {
            --bg-primary: #000000;
            --bg-secondary: #2d1b2e;
            --border-color: #9B4F96;
            --text-primary: #FFA07A;
            --text-secondary: #FF7F50;
            --accent-color: #FF4500;
            --status-todo: #2d1b2e;
            --status-in-progress: #9B4F96;
            --status-done: #FF7F50;
        }

        /* Aurora Theme */
        .theme-aurora {
            --bg-primary: #000000;
            --bg-secondary: #1a1f2c;
            --border-color: #4B0082;
            --text-primary: #7FFFD4;
            --text-secondary: #00CED1;
            --accent-color: #00BFFF;
            --status-todo: #1a1f2c;
            --status-in-progress: #4B0082;
            --status-done: #00CED1;
        }

        /* Twilight Theme */
        .theme-twilight {
            --bg-primary: #000000;
            --bg-secondary: #1e1b2e;
            --border-color: #9370DB;
            --text-primary: #E6E6FA;
            --text-secondary: #D8BFD8;
            --accent-color: #BA55D3;
            --status-todo: #1e1b2e;
            --status-in-progress: #9370DB;
            --status-done: #BA55D3;
        }

        /* Ocean Theme */
        .theme-ocean {
            --bg-primary: #000000;
            --bg-secondary: #1a2a3a;
            --border-color: #4682B4;
            --text-primary: #87CEEB;
            --text-secondary: #00BFFF;
            --accent-color: #1E90FF;
            --status-todo: #1a2a3a;
            --status-in-progress: #4682B4;
            --status-done: #00BFFF;
        }

        /* Apply theme variables */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .pr-box {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .status-bar {
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .status-icon.connected {
            color: var(--text-primary);
        }

        .status-icon.disconnected {
            color: var(--border-color);
        }

        .credential-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .credential-label,
        .remove-credentials,
        .settings-icon,
        .pr-label,
        .setup-message,
        .user-info,
        .token-info,
        .clear-token,
        .jira-info,
        .jira-ticket-age,
        .hide-section,
        .cache-info {
            color: var(--text-secondary);
        }

        .settings-icon:hover,
        .cache-info:hover {
            color: var(--text-primary);
        }

        .error-message {
            color: var(--accent-color);
        }

        .setup-link,
        .pr-link,
        .jira-key,
        .pr-list {
            color: var(--text-primary);
        }

        .token-input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .save-button,
        .clear-cache-button {
            background: var(--text-secondary);
        }

        .save-button:hover,
        .clear-cache-button:hover {
            background: var(--accent-color);
        }

        .load-more-button {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .load-more-button:hover {
            background: var(--bg-secondary);
            border-color: var(--text-secondary);
        }

        .status-todo { background-color: var(--status-todo); }
        .status-in-progress { background-color: var(--status-in-progress); }
        .status-done { background-color: var(--status-done); }

        .cache-info::after {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
    </style>
</head>
<body class="theme-dusk">
    <h3>new tab dash</h3>
    <div class="pr-box">
        <div class="pr-label">
            <span id="prCount">-</span> Pending PR Reviews
        </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="pr-list" id="prList"></div>
        
        <div class="pr-label">
            <span id="myPrCount">-</span> Open PRs
        </div>
        <div class="pr-list" id="myPrList"></div>

        <div class="pr-label">
            <span id="jiraCount">-</span> Jira Tickets
            <a href="#" class="hide-section" id="hideJiraSection" style="display: none;">Hide</a>
        </div>
        <div class="pr-list" id="jiraList"></div>

        <div class="setup-message" id="setupMessage">
            <p>You need to set up a GitHub token to view PR reviews.</p>
            <a href="https://github.com/settings/tokens/new?scopes=repo&description=PR%20Review%20Counter" 
               target="_blank" 
               class="setup-link">
                Create GitHub Token
            </a>
            <div id="tokenInputContainer">
                <input type="text" 
                       class="token-input" 
                       id="tokenInput" 
                       placeholder="Paste your GitHub token here">
                <button class="save-button" id="saveToken">Save Token</button>
            </div>
        </div>

        <div class="setup-message" id="jiraSetupMessage">
            <p>Configure Jira Integration</p>
            <a href="https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/" 
               target="_blank" 
               class="setup-link">
                How to get your Jira API token
            </a>
            <div id="jiraInputContainer">
                <input type="text" 
                       class="token-input" 
                       id="jiraDomainInput" 
                       placeholder="Your Jira domain (e.g., company.atlassian.net)">
                <input type="text" 
                       class="token-input" 
                       id="jiraEmailInput" 
                       placeholder="Your Jira email">
                <input type="text" 
                       class="token-input" 
                       id="jiraTokenInput" 
                       placeholder="Your Jira API token">
                <button class="save-button" id="saveJiraConfig">Save Jira Config</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-bar-left">
                <div class="status-icons">
                    <div class="status-icon" id="githubStatus">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        <div class="credential-modal" id="githubCredentialModal">
                            <div class="credential-info">
                                <span class="credential-label">Username:</span>
                                <span class="credential-value" id="githubUsernameDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Token:</span>
                                <span class="credential-value" id="githubTokenDisplay">-</span>
                            </div>
                            <a class="remove-credentials" id="removeGithubCredentials">Remove credentials</a>
                        </div>
                    </div>
                    <div class="status-icon" id="jiraStatus">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.808 7.552L8.69.667 8 0 2.642 5.183l-2.45 2.37A.623.623 0 000 8c0 .168.069.329.192.447l4.895 4.73L8 16l5.358-5.183 2.45-2.37a.623.623 0 00.192-.447.623.623 0 00-.192-.448zM8 10.365L5.554 8 8 5.635 10.446 8 8 10.365z"/>
                            <path d="M8 5.635c-1.26-1.22-1.26-3.197 0-4.417L3.554 5.183 5.554 8 8 5.635z" fill-opacity="0.3"/>
                            <path d="M10.446 8l-2.446 2.365c1.26 1.22 1.26 3.197 0 4.417l4.446-3.965L10.446 8z" fill-opacity="0.3"/>
                        </svg>
                        <div class="credential-modal" id="jiraCredentialModal">
                            <div class="credential-info">
                                <span class="credential-label">Domain:</span>
                                <span class="credential-value" id="jiraDomainDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Email:</span>
                                <span class="credential-value" id="jiraEmailDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Token:</span>
                                <span class="credential-value" id="jiraTokenDisplay">-</span>
                            </div>
                            <div class="credential-info">
                                <span class="credential-label">Visibility:</span>
                                <a href="#" class="hide-section" id="toggleJiraVisibility">Show/Hide Section</a>
                            </div>
                            <a class="remove-credentials" id="removeJiraCredentials">Remove credentials</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-bar-right">
                <div class="user-info" id="userInfo"></div>
                <div class="cache-info" id="cacheInfo"></div>
            </div>
        </div>
    </div>

    <div class="theme-selector">
        <div class="theme-icon theme-dusk active" style="background: #F8B195;" title="Dusk Theme"></div>
        <div class="theme-icon theme-sunrise" style="background: #FFB6C1;" title="Sunrise Theme"></div>
        <div class="theme-icon theme-sunset" style="background: #FFA07A;" title="Sunset Theme"></div>
        <div class="theme-icon theme-aurora" style="background: #7FFFD4;" title="Aurora Theme"></div>
        <div class="theme-icon theme-twilight" style="background: #E6E6FA;" title="Twilight Theme"></div>
        <div class="theme-icon theme-ocean" style="background: #87CEEB;" title="Ocean Theme"></div>
    </div>

    <script>
        const GITHUB_CONFIG = {
            token: localStorage.getItem('githubToken') || '',
            username: localStorage.getItem('githubUsername') || '',
            cacheDuration: 5 * 60 * 1000, // 5 minutes in milliseconds
            cachePrefix: 'github_cache_',
            cacheTimer: null
        };

        const JIRA_CONFIG = {
            domain: localStorage.getItem('jiraDomain') || '',
            token: localStorage.getItem('jiraToken') || '',
            email: localStorage.getItem('jiraEmail') || '',
            cacheDuration: 5 * 60 * 1000, // 5 minutes in milliseconds
            cachePrefix: 'jira_cache_',
            cacheTimer: null,
            isVisible: localStorage.getItem('jiraVisible') !== 'false' // Default to true if not set
        };

        // Cache management functions
        function getCacheKey(endpoint) {
            return `${GITHUB_CONFIG.cachePrefix}${endpoint}`;
        }

        function updateCacheTimer() {
            const cacheInfo = document.getElementById('cacheInfo');
            const allCacheKeys = Object.keys(localStorage).filter(key => key.startsWith(GITHUB_CONFIG.cachePrefix));
            
            if (allCacheKeys.length === 0) {
                cacheInfo.textContent = '';
                if (GITHUB_CONFIG.cacheTimer) {
                    clearInterval(GITHUB_CONFIG.cacheTimer);
                    GITHUB_CONFIG.cacheTimer = null;
                }
                return;
            }

            let maxTimeLeft = 0;
            let hasValidCache = false;
            
            allCacheKeys.forEach(key => {
                try {
                    const { timestamp } = JSON.parse(localStorage.getItem(key));
                    const timeLeft = GITHUB_CONFIG.cacheDuration - (Date.now() - timestamp);
                    if (timeLeft > 0) {
                        hasValidCache = true;
                        maxTimeLeft = Math.max(maxTimeLeft, timeLeft);
                    }
                } catch (e) {
                    console.error('Cache parse error:', e);
                }
            });

            if (!hasValidCache || maxTimeLeft <= 0) {
                cacheInfo.textContent = '';
                if (GITHUB_CONFIG.cacheTimer) {
                    clearInterval(GITHUB_CONFIG.cacheTimer);
                    GITHUB_CONFIG.cacheTimer = null;
                }
                return;
            }

            const minutes = Math.floor(maxTimeLeft / 60000);
            const seconds = Math.floor((maxTimeLeft % 60000) / 1000);
            cacheInfo.textContent = `ttl ${minutes}m ${seconds}s`;
        }

        // Initialize cache timer if there's cached data
        function initializeCacheTimer() {
            const allCacheKeys = Object.keys(localStorage).filter(key => key.startsWith(GITHUB_CONFIG.cachePrefix));
            if (allCacheKeys.length > 0) {
                updateCacheTimer();
                if (!GITHUB_CONFIG.cacheTimer) {
                    GITHUB_CONFIG.cacheTimer = setInterval(updateCacheTimer, 1000);
                }
            }
        }

        // Call initializeCacheTimer when the page loads
        initializeCacheTimer();

        function getCachedData(endpoint) {
            const cacheKey = getCacheKey(endpoint);
            const cached = localStorage.getItem(cacheKey);
            if (!cached) return null;

            try {
                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();
                const timeLeft = GITHUB_CONFIG.cacheDuration - (now - timestamp);
                
                if (timeLeft > 0) {
                    // Start or restart the timer if not running
                    if (!GITHUB_CONFIG.cacheTimer) {
                        GITHUB_CONFIG.cacheTimer = setInterval(updateCacheTimer, 1000);
                    }
                    updateCacheTimer();
                    return data;
                }
                // Cache expired, remove it
                localStorage.removeItem(cacheKey);
                updateCacheTimer();
                return null;
            } catch (e) {
                console.error('Cache parse error:', e);
                updateCacheTimer();
                return null;
            }
        }

        function setCachedData(endpoint, data) {
            const cacheKey = getCacheKey(endpoint);
            const cacheData = {
                data,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                // Start or restart the timer
                if (!GITHUB_CONFIG.cacheTimer) {
                    GITHUB_CONFIG.cacheTimer = setInterval(updateCacheTimer, 1000);
                }
                updateCacheTimer();
            } catch (e) {
                console.error('Cache storage error:', e);
                updateCacheTimer();
            }
        }

        async function fetchWithCache(url, options = {}) {
            const cachedData = getCachedData(url);
            if (cachedData) {
                console.log('Using cached data for:', url);
                return {
                    ok: true,
                    status: 200,
                    json: async () => cachedData
                };
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                setCachedData(url, data);
                return {
                    ok: true,
                    status: 200,
                    json: async () => data
                };
            } catch (error) {
                console.error('Fetch error:', error);
                updateCacheTimer();
                throw error;
            }
        }

        function updateTokenDisplay() {
            const setupMessage = document.getElementById('setupMessage');
            const githubStatus = document.getElementById('githubStatus');

            if (GITHUB_CONFIG.token) {
                // Update status indicator
                githubStatus.className = 'status-icon connected';
                // Hide setup message
                setupMessage.style.display = 'none';
            } else {
                // Update status indicator
                githubStatus.className = 'status-icon disconnected';
                // Show setup message
                setupMessage.style.display = 'block';
            }
        }

        // Debug logging
        console.log('Initial token:', GITHUB_CONFIG.token ? 'Present' : 'Missing');
        updateTokenDisplay();

        async function testToken() {
            try {
                console.log('Testing token...');
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                console.log('Token test response status:', response.status);
                
                if (response.ok) {
                    const userData = await response.json();
                    console.log('Token valid, connected as:', userData.login);
                    GITHUB_CONFIG.username = userData.login;
                    localStorage.setItem('githubUsername', userData.login);
                    return true;
                } else {
                    const errorData = await response.json();
                    console.error('Token validation failed:', response.status, errorData);
                    return false;
                }
            } catch (error) {
                console.error('Error testing token:', error);
                return false;
            }
        }

        async function fetchPRReviews() {
            try {
                console.log('Fetching PR reviews...');
                if (!GITHUB_CONFIG.token) {
                    console.log('No token found');
                    document.getElementById('setupMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'GitHub token not configured';
                    return;
                }

                // Test the token first
                const isValid = await testToken();
                if (!isValid) {
                    console.log('Token invalid');
                    document.getElementById('setupMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'GitHub token is invalid or expired';
                    localStorage.removeItem('githubToken'); // Clear invalid token
                    GITHUB_CONFIG.token = '';
                    updateTokenDisplay(); // Update UI after clearing token
                    return;
                }

                const response = await fetchWithCache('https://api.github.com/search/issues?q=is:pr+is:open+review-requested:@me', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                console.log('PR fetch response:', response);

                if (response.status === 401) {
                    console.log('Token unauthorized');
                    document.getElementById('setupMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'GitHub token is invalid or expired';
                    localStorage.removeItem('githubToken'); // Clear invalid token
                    GITHUB_CONFIG.token = '';
                    updateTokenDisplay(); // Update UI after clearing token
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to fetch PR reviews: ${errorData.message || response.status}`);
                }

                const data = await response.json();
                console.log('PR data:', data);
                const prCount = data.total_count;
                document.getElementById('prCount').textContent = prCount;
                
                // Update PR list
                const prList = document.getElementById('prList');
                prList.innerHTML = '';
                data.items.forEach(pr => {
                    const repo = pr.repository_url.split('/').slice(-2).join('/');
                    const prItem = document.createElement('div');
                    prItem.className = 'pr-item';
                    prItem.innerHTML = `
                        <div class="pr-title">${pr.title}</div>
                        <a href="${pr.html_url}" target="_blank" class="pr-link">${repo}#${pr.number}</a>
                    `;
                    prList.appendChild(prItem);
                });

                // Fetch user's open PRs
                const myPrResponse = await fetchWithCache('https://api.github.com/search/issues?q=is:pr+is:open+author:@me', {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (myPrResponse.ok) {
                    const myPrData = await myPrResponse.json();
                    const myPrCount = myPrData.total_count;
                    document.getElementById('myPrCount').textContent = myPrCount;
                    
                    // Update user's PR list
                    const myPrList = document.getElementById('myPrList');
                    myPrList.innerHTML = '';
                    myPrData.items.forEach(pr => {
                        const repo = pr.repository_url.split('/').slice(-2).join('/');
                        const prItem = document.createElement('div');
                        prItem.className = 'pr-item';
                        prItem.innerHTML = `
                            <div class="pr-title">${pr.title}</div>
                            <a href="${pr.html_url}" target="_blank" class="pr-link">${repo}#${pr.number}</a>
                        `;
                        myPrList.appendChild(prItem);
                    });
                }

                document.getElementById('setupMessage').style.display = 'none';
                document.getElementById('errorMessage').textContent = '';
            } catch (error) {
                console.error('Error in fetchPRReviews:', error);
                document.getElementById('errorMessage').textContent = `Error: ${error.message}`;
            }
        }

        // Setup token saving
        document.getElementById('saveToken').addEventListener('click', async () => {
            const token = document.getElementById('tokenInput').value.trim();
            console.log('Saving new token...');
            if (token) {
                localStorage.setItem('githubToken', token);
                GITHUB_CONFIG.token = token;
                updateTokenDisplay();
                await fetchPRReviews();
            }
        });

        // If we have a token, try to use it
        if (GITHUB_CONFIG.token) {
            console.log('Found existing token, attempting to use it...');
            fetchPRReviews();
        } else {
            console.log('No existing token found');
            document.getElementById('setupMessage').style.display = 'block';
        }

        // Setup Jira config saving
        document.getElementById('saveJiraConfig').addEventListener('click', async () => {
            const domain = document.getElementById('jiraDomainInput').value.trim();
            const email = document.getElementById('jiraEmailInput').value.trim();
            const token = document.getElementById('jiraTokenInput').value.trim();
            if (domain && email && token) {
                localStorage.setItem('jiraDomain', domain);
                localStorage.setItem('jiraEmail', email);
                localStorage.setItem('jiraToken', token);
                JIRA_CONFIG.domain = domain;
                JIRA_CONFIG.email = email;
                JIRA_CONFIG.token = token;
                updateJiraDisplay();
                await fetchJiraTickets();
            }
        });

        // If we have Jira config, try to use it
        if (JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token) {
            console.log('Found existing Jira config, attempting to use it...');
            document.getElementById('jiraSetupMessage').style.display = 'none';
            fetchJiraTickets();
        } else {
            console.log('No existing Jira config found');
            document.getElementById('jiraSetupMessage').style.display = 'block';
        }

        // Initialize Jira visibility state
        function initializeJiraVisibility() {
            const jiraList = document.getElementById('jiraList');
            const jiraCount = document.getElementById('jiraCount').parentElement;
            const hideJiraSection = document.getElementById('hideJiraSection');
            const toggleJiraVisibility = document.getElementById('toggleJiraVisibility');
            const jiraSetupMessage = document.getElementById('jiraSetupMessage');

            // If credentials are set, always show the tickets section
            if (JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token) {
                jiraList.style.display = 'block';
                jiraCount.style.display = 'block';
                jiraSetupMessage.style.display = 'none';
                hideJiraSection.style.display = 'none';
                toggleJiraVisibility.textContent = 'Hide Section';
            } else {
                // No credentials - show/hide based on visibility preference
                if (JIRA_CONFIG.isVisible) {
                    jiraSetupMessage.style.display = 'block';
                    hideJiraSection.style.display = 'inline';
                    toggleJiraVisibility.textContent = 'Hide Section';
                } else {
                    jiraSetupMessage.style.display = 'none';
                    hideJiraSection.style.display = 'none';
                    toggleJiraVisibility.textContent = 'Show Section';
                }
                jiraList.style.display = 'none';
                jiraCount.style.display = 'none';
            }
        }

        // Call initializeJiraVisibility when the page loads
        initializeJiraVisibility();

        function updateJiraDisplay() {
            const jiraDomainInput = document.getElementById('jiraDomainInput');
            const jiraEmailInput = document.getElementById('jiraEmailInput');
            const jiraTokenInput = document.getElementById('jiraTokenInput');
            const jiraSetupMessage = document.getElementById('jiraSetupMessage');
            const jiraStatus = document.getElementById('jiraStatus');
            const hideJiraSection = document.getElementById('hideJiraSection');
            const jiraList = document.getElementById('jiraList');
            const jiraCount = document.getElementById('jiraCount').parentElement;
            const toggleJiraVisibility = document.getElementById('toggleJiraVisibility');

            console.log('Current Jira Configuration:', {
                domain: JIRA_CONFIG.domain,
                email: JIRA_CONFIG.email,
                token: JIRA_CONFIG.token ? 'Present' : 'Missing',
                isVisible: JIRA_CONFIG.isVisible
            });

            const hasCredentials = JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token;

            if (hasCredentials) {
                // Update status indicator
                jiraStatus.className = 'status-icon connected';
                // Hide setup message
                jiraSetupMessage.style.display = 'none';
                // Hide the hide link in the main area
                hideJiraSection.style.display = 'none';
                // Show tickets
                jiraList.style.display = 'block';
                jiraCount.style.display = 'block';
                toggleJiraVisibility.textContent = 'Hide Section';
                // Clear input fields
                const inputs = document.querySelectorAll('#jiraDomainInput, #jiraEmailInput, #jiraTokenInput');
                inputs.forEach(input => input.value = '');
            } else {
                // Update status indicator
                jiraStatus.className = 'status-icon disconnected';
                // Show/hide setup message based on visibility
                jiraSetupMessage.style.display = JIRA_CONFIG.isVisible ? 'block' : 'none';
                // Show/hide the hide link based on visibility
                hideJiraSection.style.display = JIRA_CONFIG.isVisible ? 'inline' : 'none';
                // Hide tickets
                jiraList.style.display = 'none';
                jiraCount.style.display = 'none';
                toggleJiraVisibility.textContent = JIRA_CONFIG.isVisible ? 'Hide Section' : 'Show Section';
            }
        }

        async function fetchJiraTickets() {
            try {
                console.log('Fetching Jira tickets...');
                console.log('Jira Config:', {
                    domain: JIRA_CONFIG.domain,
                    email: JIRA_CONFIG.email,
                    hasToken: !!JIRA_CONFIG.token
                });

                if (!JIRA_CONFIG.domain || !JIRA_CONFIG.email || !JIRA_CONFIG.token) {
                    console.log('Jira config incomplete');
                    document.getElementById('jiraSetupMessage').style.display = 'block';
                    document.getElementById('jiraStatus').className = 'status-icon disconnected';
                    return;
                }

                // Ensure domain is in correct format
                let domain = JIRA_CONFIG.domain;
                if (!domain.includes('.atlassian.net')) {
                    domain = `${domain}.atlassian.net`;
                }

                // First, test authentication with a simple API call
                const testUrl = `https://${domain}/rest/api/2/myself`;
                console.log('Testing Jira authentication...');
                
                const testResponse = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Basic ${btoa(`${JIRA_CONFIG.email}:${JIRA_CONFIG.token}`)}`,
                        'Accept': 'application/json'
                    }
                });

                if (!testResponse.ok) {
                    const errorText = await testResponse.text();
                    console.error('Jira authentication failed:', testResponse.status, errorText);
                    document.getElementById('jiraStatus').className = 'status-icon disconnected';
                    throw new Error(`Jira authentication failed: ${testResponse.status}`);
                }

                const userData = await testResponse.json();
                console.log('Jira authentication successful, logged in as:', userData.displayName);
                document.getElementById('jiraStatus').className = 'status-icon connected';

                // Now fetch the tickets
                const jql = 'assignee=currentUser() AND status not in (Done,Closed,Resolved) ORDER BY priority DESC, updated DESC';
                const url = `https://${domain}/rest/api/2/search?jql=${encodeURIComponent(jql)}&maxResults=100`;
                console.log('Fetching Jira tickets from:', url);

                const response = await fetchWithCache(url, {
                    headers: {
                        'Authorization': `Basic ${btoa(`${JIRA_CONFIG.email}:${JIRA_CONFIG.token}`)}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Jira API Error Response:', errorText);
                    throw new Error(`Failed to fetch Jira tickets: ${response.status}`);
                }

                const data = await response.json();
                console.log('Jira API Response:', {
                    total: data.total,
                    numIssues: data.issues?.length || 0,
                    maxResults: data.maxResults
                });

                const ticketCount = data.total;
                document.getElementById('jiraCount').textContent = ticketCount;
                
                // Update Jira ticket list
                const jiraList = document.getElementById('jiraList');
                jiraList.innerHTML = '';
                
                if (data.issues && data.issues.length > 0) {
                    // Show first 6 tickets
                    const initialTickets = data.issues.slice(0, 6);
                    const remainingTickets = data.issues.slice(6);
                    
                    initialTickets.forEach(ticket => {
                        const ticketItem = document.createElement('div');
                        ticketItem.className = 'jira-ticket';
                        ticketItem.innerHTML = createTicketHTML(ticket, domain);
                        jiraList.appendChild(ticketItem);
                    });

                    // Add load more button if there are more tickets
                    if (remainingTickets.length > 0) {
                        const loadMoreButton = document.createElement('button');
                        loadMoreButton.className = 'load-more-button';
                        loadMoreButton.textContent = `Load ${Math.min(10, remainingTickets.length)} more tickets`;
                        
                        let displayedTickets = 6;
                        loadMoreButton.addEventListener('click', () => {
                            const nextBatch = data.issues.slice(displayedTickets, displayedTickets + 10);
                            nextBatch.forEach(ticket => {
                                const ticketItem = document.createElement('div');
                                ticketItem.className = 'jira-ticket';
                                ticketItem.innerHTML = createTicketHTML(ticket, domain);
                                jiraList.insertBefore(ticketItem, loadMoreButton);
                            });
                            
                            displayedTickets += nextBatch.length;
                            
                            if (displayedTickets >= data.issues.length) {
                                loadMoreButton.remove();
                            } else {
                                const remaining = data.issues.length - displayedTickets;
                                loadMoreButton.textContent = `Load ${Math.min(10, remaining)} more tickets`;
                            }
                        });
                        
                        jiraList.appendChild(loadMoreButton);
                    }
                } else {
                    jiraList.innerHTML = '<div class="pr-item">No tickets found</div>';
                }

                document.getElementById('jiraSetupMessage').style.display = 'none';
                document.getElementById('errorMessage').textContent = '';

            } catch (error) {
                console.error('Error in fetchJiraTickets:', error);
                document.getElementById('errorMessage').textContent = `Jira Error: ${error.message}`;
                document.getElementById('jiraStatus').className = 'status-icon disconnected';
                document.getElementById('jiraStatusText').textContent = 'Error';
                document.getElementById('jiraSetupMessage').style.display = 'block';
            }
        }

        // Helper function to create ticket HTML
        function createTicketHTML(ticket, domain) {
            let statusClass = 'status-todo';
            if (ticket.fields.status.name.toLowerCase().includes('progress')) {
                statusClass = 'status-in-progress';
            } else if (ticket.fields.status.name.toLowerCase().includes('done')) {
                statusClass = 'status-done';
            }

            // Calculate relative time and color
            const updatedTime = new Date(ticket.fields.updated);
            const now = new Date();
            const diffDays = Math.floor((now - updatedTime) / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((now - updatedTime) / (1000 * 60 * 60));
            
            let relativeTime;
            if (diffDays > 0) {
                relativeTime = `${diffDays}d`;
            } else if (diffHours > 0) {
                relativeTime = `${diffHours}h`;
            } else {
                relativeTime = '<1h';
            }

            // Color scale: green (new) -> yellow -> red (old)
            // 0-1 day: green
            // 1-3 days: yellow-green
            // 3-7 days: yellow
            // 7-14 days: orange
            // 14+ days: red
            let ageColor;
            if (diffDays === 0) {
                ageColor = '#2ecc71'; // muted green
            } else if (diffDays <= 1) {
                ageColor = '#5cb85c'; // muted yellow-green
            } else if (diffDays <= 3) {
                ageColor = '#ffff44'; // yellow
            } else if (diffDays <= 7) {
                ageColor = '#ff8844'; // orange
            } else {
                ageColor = '#ff4444'; // red
            }
            
            return `
                <div class="jira-ticket-content">
                    <div class="pr-title">
                        <span class="jira-key">${ticket.key}</span>
                        <span class="jira-status ${statusClass}">${ticket.fields.status.name}</span>
                        <span class="jira-priority" style="color: ${ticket.fields.priority.iconUrl.includes('highest') ? '#ff4444' : 
                                                                 ticket.fields.priority.iconUrl.includes('high') ? '#ff8844' : 
                                                                 ticket.fields.priority.iconUrl.includes('medium') ? '#ffcc44' : 
                                                                 '#2ecc71'}">${ticket.fields.priority.name}</span>
                    </div>
                    <a href="https://${domain}/browse/${ticket.key}" 
                       target="_blank" 
                       class="pr-link">${ticket.fields.summary}</a>
                </div>
                <span class="jira-ticket-age" style="color: ${ageColor}">${relativeTime}</span>
            `;
        }

        // Add click handler for cache info
        document.getElementById('cacheInfo').addEventListener('click', () => {
            // Clear all GitHub caches
            Object.keys(localStorage)
                .filter(key => key.startsWith(GITHUB_CONFIG.cachePrefix))
                .forEach(key => localStorage.removeItem(key));
            
            // Clear all Jira caches
            Object.keys(localStorage)
                .filter(key => key.startsWith(JIRA_CONFIG.cachePrefix))
                .forEach(key => localStorage.removeItem(key));
            
            // Update the display
            updateCacheTimer();
            
            // Refresh the data
            if (GITHUB_CONFIG.token) {
                fetchPRReviews();
            }
            if (JIRA_CONFIG.domain && JIRA_CONFIG.email && JIRA_CONFIG.token) {
                fetchJiraTickets();
            }
        });

        // Add credential display and removal functionality
        function updateCredentialDisplays() {
            // Update GitHub credential displays
            const githubToken = GITHUB_CONFIG.token;
            const githubTokenDisplay = document.getElementById('githubTokenDisplay');
            const githubUsernameDisplay = document.getElementById('githubUsernameDisplay');
            
            if (githubToken) {
                githubTokenDisplay.textContent = `••••${githubToken.slice(-4)}`;
                githubUsernameDisplay.textContent = GITHUB_CONFIG.username || '-';
            } else {
                githubTokenDisplay.textContent = '-';
                githubUsernameDisplay.textContent = '-';
            }

            // Update Jira credential displays
            const jiraDomainDisplay = document.getElementById('jiraDomainDisplay');
            const jiraEmailDisplay = document.getElementById('jiraEmailDisplay');
            const jiraTokenDisplay = document.getElementById('jiraTokenDisplay');
            const removeJiraCredentials = document.getElementById('removeJiraCredentials');
            const toggleJiraVisibility = document.getElementById('toggleJiraVisibility');
            const visibilityContainer = toggleJiraVisibility.parentElement;

            jiraDomainDisplay.textContent = JIRA_CONFIG.domain || '-';
            jiraEmailDisplay.textContent = JIRA_CONFIG.email || '-';
            if (JIRA_CONFIG.token) {
                jiraTokenDisplay.textContent = `••••${JIRA_CONFIG.token.slice(-4)}`;
            } else {
                jiraTokenDisplay.textContent = '-';
            }

            // Show/hide remove credentials link based on whether any credentials are set
            const hasAnyJiraCredentials = JIRA_CONFIG.domain || JIRA_CONFIG.email || JIRA_CONFIG.token;
            removeJiraCredentials.style.display = hasAnyJiraCredentials ? 'inline-block' : 'none';
            visibilityContainer.style.display = hasAnyJiraCredentials ? 'none' : 'block';
        }

        // Add click handlers for removing credentials
        document.getElementById('removeGithubCredentials').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('githubToken');
            localStorage.removeItem('githubUsername');
            GITHUB_CONFIG.token = '';
            GITHUB_CONFIG.username = '';
            updateTokenDisplay();
            updateCredentialDisplays();
            document.getElementById('setupMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = '';
        });

        document.getElementById('removeJiraCredentials').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('jiraDomain');
            localStorage.removeItem('jiraEmail');
            localStorage.removeItem('jiraToken');
            JIRA_CONFIG.domain = '';
            JIRA_CONFIG.email = '';
            JIRA_CONFIG.token = '';
            JIRA_CONFIG.isVisible = true; // Set to true so the next action is to hide
            localStorage.setItem('jiraVisible', true);
            document.getElementById('toggleJiraVisibility').textContent = 'Hide Section';
            updateJiraDisplay();
            updateCredentialDisplays();
            document.getElementById('jiraSetupMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = '';
        });

        // Update credential displays when the page loads
        updateCredentialDisplays();

        // Update credential displays when tokens are saved
        document.getElementById('saveToken').addEventListener('click', () => {
            setTimeout(updateCredentialDisplays, 100);
        });

        document.getElementById('saveJiraConfig').addEventListener('click', () => {
            setTimeout(updateCredentialDisplays, 100);
        });

        // Add click handler for toggling Jira visibility
        document.getElementById('toggleJiraVisibility').addEventListener('click', (e) => {
            e.preventDefault();
            JIRA_CONFIG.isVisible = !JIRA_CONFIG.isVisible;
            localStorage.setItem('jiraVisible', JIRA_CONFIG.isVisible);
            updateJiraDisplay();
            // If showing the section and no credentials are set, show the setup message
            if (JIRA_CONFIG.isVisible && !JIRA_CONFIG.domain && !JIRA_CONFIG.email && !JIRA_CONFIG.token) {
                document.getElementById('jiraSetupMessage').style.display = 'block';
            }
        });

        // Add click handler for hiding Jira section from main area
        document.getElementById('hideJiraSection').addEventListener('click', (e) => {
            e.preventDefault();
            JIRA_CONFIG.isVisible = false;
            localStorage.setItem('jiraVisible', false);
            updateJiraDisplay();
        });

        // Theme switching functionality
        document.querySelectorAll('.theme-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                // Remove active class from all icons
                document.querySelectorAll('.theme-icon').forEach(i => i.classList.remove('active'));
                // Add active class to clicked icon
                icon.classList.add('active');
                // Apply the theme
                document.body.className = icon.classList[1];
            });
        });
    </script>
</body>
</html>